# Building native images

## Prerequisites

* GraalVM
* `native-image` via graalvm updater `gu`
* "build-essentials", i.e. gcc and friends
* static libraries zlib and libc (glibc for arm64)

## Tracing Agent

See [GraalVM docs: Assisted Configuration with Tracing Agent](https://www.graalvm.org/22.0/reference-manual/native-image/Agent/)

### Motivation

`native-image` has some limitations on what it can discover at build-time. For example, it can discover some reflection usage in your code, but not all. Also loading resources from classpath won't work at run-time as resource are not included by default. That's where the Tracing Agent comes in and helps to discover these edge cases.

Before running the integration tests the plain (i.e. non-native-image) java application is being run using the Tracing Agent which is part of the GraalVM distribution. Therefore it is very important for the integration tests to cover as much of the critical code paths in minchir as possible.

Unfortunately, the resulting json files generated by the Tracing Agent should be manually checked (as recommended by the native-image docs). Especially the classes serialized/deserialized by Gson are discovered but only parts of the reflection metadata is deemed neccessary. These entries in `reflect-config.json` must be amended manually, thus, the generated json files are not automatically re-generated during CI/CD.

### Usage

1. Start the testing infrastructure defined in the `docker` subfolder and wait for all contains to be properly inititialized:
   ```sh
   $ cd project-root/docker
   $ docker-compose up
   ```

2. Start minchir w/ the Tracing Agent and wait for minchir to be up and running:
   ```sh
   $ cd project-root/app
   $ APP_OPTS="\
         -Xmx300M \
         -agentlib:native-image-agent=config-output-dir=/tmp/META-INF/native-image \
         -Djavax.net.ssl.trustStore=../docker/certs/truststore.jks \
         -Djavax.net.ssl.trustStorePassword=changeit" \
       build/install/app/bin/app \
         --config assets/config/config.yaml \
         --config src/test/resources/integtest/config.yaml \
         --scopes assets/scopes/scopes.yaml \
         --translation assets/i18n/translations.yaml
   ```
   _NOTE: minchir **should** be run using GraalVM as other jdk distribution will most likely provide the Tracing Agent!_
3. Run the integration tests to trigger the critical code paths in the minchir instance:
   ```sh
   $ cd project-root/app
   $ ../gradlew cleanIntegTest integTest
   ```

4. Stop minchir using `CTRL+C` to have the Tracing Agent write out the gathered information in to `/tmp/META-INF/...`. These files can now be merged with those in `project-root/app/src/main/resources/META-INF`.

## Native Image

### Prerequisites

* Tracing Agent recorded hints for native image creation (see previous chapter).
* Gradle task `installDist` prepared the jars needed for distribution as classic java application (in folder `build/install/...`)

### Native Image build

```sh
$ cd project-root/app/native-image
$ native-image \
        --no-fallback \
        --static \
        --libc=glibc \
        --class-path '../build/install/app/lib/*' \
        com.github.lbarnkow.minchir.App \
        minchir
```

### Starting the native-image

```sh
$ cd project-root/app
$ native-image/minchir --help
$ native-image/minchir \
    --config assets/config/config.yaml \
    --config src/test/resources/integtest/config.yaml \
    --scopes assets/scopes/scopes.yaml \
    --translation assets/i18n/translations.yaml \
    -Djavax.net.ssl.trustStore=../docker/certs/truststore.jks \
    -Djavax.net.ssl.trustStorePassword=changeit
```
